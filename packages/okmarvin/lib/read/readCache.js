'use strict'

const fs = require('fs-extra')
const path = require('path')

/**
 * In okmarvin, file composed of site config, file data,
 * file template, file layout, client js, and file css
 * data is generated by markdown-it, so we need to take it into account too
 * for incremental rebuild, we need to figure all of theme out
 */

const defaultCache = {
  themeManifest: Object.create(null), // medium change frequency
  clientJsManifest: Object.create(null), // medium change frequency
  files: [], // high change frequency
  layoutHash: [], // low change frequency
  okmarvinConfig: Object.create(null), // low change frequency
  site: Object.create(null) // low change frequency
}

module.exports = ({ root }, callback) => {
  // Cache for incremental rebuild
  try {
    const data = fs.readJsonSync(path.join(root, '_cache.json'))
    callback(null, {
      ...defaultCache,
      ...data
    })
  } catch (err) {
    return callback(null, defaultCache)
  }
}
